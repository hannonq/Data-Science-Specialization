---
title: "U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database"
author: "Hannon Queiroz"
date: "25 July 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Synopsis

## Questions
1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

## Getting the data
First, let's download the data. The data used for this analysis was downloaded on 25/07/2017
```{r}
fileUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
if(!file.exists("./dataset.bz2")){
    # dir.create("./data")
    download.file(fileUrl, destfile="./dataset.bz2", method="curl")
}
```

## Helper functions
This function checks if a package is already installed in the system, and installs it if needed
```{r  message=FALSE, results='hide'}
checkAndInstall <- function(pkgName){
    if(pkgName %in% rownames(installed.packages()) == FALSE){
        install.packages(pkgName)
    }
}
```


## Loading the data
Because the data is compressed in a `.bz2` file, let's first uncompress it using the `bunzip2` function from the `R.utils` package.
```{r message=FALSE, results='hide'}
checkAndInstall("R.utils")
library(R.utils)
bunzip2("dataset.bz2", remove = FALSE, skip = TRUE)
```


## Data Processing
Let's read the data using the `data.table` package.
For the purpose of this assignment, only some of the columns in the dataset have been selected.
```{r cache=TRUE}
# Check if package is installed, and install it if necessary
checkAndInstall("data.table")
library(data.table)
data <- fread("dataset", sep = ',', na.strings = c(""), 
              select = c("EVTYPE", "FATALITIES", "INJURIES", "WFO", "F",
                         "MAG", "PROPDMG", "PROPDMGEXP", "CROPDMG",
                         "CROPDMGEXP")
)

```

Now, let's take a look at what our dataset looks like:
```{r}
print(str(data))
print(head(data))
```

To address the first question, let's look at the `EVTYPE` column
```{r}
length(unique(data$EVTYPE))
```
We can see that there are way too many entries. Looking at the data may enlighten us as to why that is.
The data is sorted before the `print` function is called to make it easier to spot typos.

```{r}
print(sort(unique(data$EVTYPE)))
```

The first cleaning that will be done is to set all the strings to lower case.
```{r}
data$EVTYPE <- tolower(data$EVTYPE)
```

Secondly, let's remove all numeric values from the event types, as they are not relevant for this analisys.
e.g. replace "hail 0.75" with "hail"

```{r cache=TRUE}
regmatches(
    data$EVTYPE,
    gregexpr("[[:digit:]]+\\.*[[:digit:]]*", data$EVTYPE)
) <- ""
```

```{r cache=TRUE, eval=FALSE}
data$EVTYPE <- gsub("\\([^\\)]+\\)","", data$EVTYPE)
```

Remove all non-alphanumeric characters and remove unecessary whitespaces:
```{r cache=TRUE,  message=FALSE, results='hide'}
checkAndInstall("qdap")
library(qdap)
data$EVTYPE <- Trim(clean(gsub("\\W", " ", data$EVTYPE)))
# data$EVTYPE <- gsub("\W", " ", data$EVTYPE)
```

Replace "tstm" with "thunderstorm"
```{r cache=TRUE}
data$EVTYPE <- gsub("tstm","thunderstorm", data$EVTYPE)
```

Suppress the hurricane name
```{r cache=TRUE}
data$EVTYPE <- gsub("hurricane.*","hurricane", data$EVTYPE)
```

Since the official event name for thunderstorm-related events is "thunderstorm wind", we can clean all the thunderstorm-related names.
```{r cache=TRUE}
data$EVTYPE <- gsub(".*thunderstorm.*","thunderstorm wind", data$EVTYPE)
```

Same for snow events
```{r cache=TRUE}
data$EVTYPE <- gsub(".*snow*","heavy snow", data$EVTYPE)
```


Let's take another look now:
```{r}
print(length(unique(data$EVTYPE)))
print(sort(unique(data$EVTYPE)))
```

Now, let's try to remove the duplicates caused by typos. For that, we'll use the `amatch` function from the `stringdist` package.
```{r}
checkAndInstall("stringdist")
library(stringdist)
```

```{r cache=TRUE}
checkAndInstall("dplyr")
library(dplyr)

freq <- as.data.frame(table(data$EVTYPE))
freq <- arrange(freq, desc(Freq))
print(freq)
d <- adist(freq[, 1])
rownames(d) <- freq[, 1]
hc <- hclust(as.dist(d))
```
```{r fig.width=100, fig.height=15}
plot(hc, hang = -1, cex = 0.8)
rect.hclust(hc,k=60)
```

```{r}
print(quantile(freq$Freq, c(.25, .50, .85)))
```






## Acknowledgements
[This post][1] by Usama A.F. Khalil was of great help during the developtment of this assignment.

[1]: https://www.coursera.org/learn/reproducible-research/discussions/weeks/4/threads/IdtP_JHzEeaePQ71AQUtYw "Post"



